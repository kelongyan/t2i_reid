# T2I-ReID 模型消融实验实施方案

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档版本** | v1.0 |
| **创建日期** | 2026-02-02 |
| **适用数据集** | CUHK-PEDES, RSTPReid, ICFG-PEDES |
| **实验基准模型** | T2I-ReID with Vision Mamba + AH-Net + Fusion |
| **文档格式** | Markdown (GitHub Flavored) |

---

## 目录

- [1. 概述](#1-概述)
- [2. 实验目标](#2-实验目标)
- [3. 实验设置](#3-实验设置)
- [4. 消融实验组设计](#4-消融实验组设计)
- [5. 实验实施细节](#5-实验实施细节)
- [6. 结果分析方法](#6-结果分析方法)
- [7. 预期结果与讨论](#7-预期结果与讨论)
- [8. 附录：命令脚本](#8-附录命令脚本)

---

## 1. 概述

### 1.1 实验目的

本消融实验旨在系统性地评估 T2I-ReID（Text-to-Image Person Re-Identification）模型中各个核心组件的有效性，通过移除或替换特定模块，量化各组件对模型整体性能的贡献。

### 1.2 模型架构概览

T2I-ReID 模型由以下核心组件构成：

```
┌─────────────────────────────────────────────────────────────┐
│                    T2I-ReID Model Architecture              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  [图像分支]             [文本分支]                          │
│       │                     │                               │
│       ▼                     ▼                               │
│  Vision Mamba         CLIP Text Encoder                     │
│  (或 ViT)              + PyramidTextEncoder                  │
│       │                     │                               │
│       ▼                     ▼                               │
│  ┌──────────────────────────────────────┐                  │
│  │         AH-Net 解耦模块              │                  │
│  │  ┌────────────────────────────┐   │                  │
│  │  │ ID 结构流     属性纹理流   │   │                  │
│  │  │   (Mamba)      (CNN+ECA)   │   │                  │
│  │  └────────────────────────────┘   │                  │
│  └──────────────────────────────────────┘                  │
│       │                     │                               │
│  ┌────┴─────────────────────┴────┐                         │
│  │    语义引导模块  +  对抗解耦    │                        │
│  │   (Semantic Guidance + GRL)    │                        │
│  └────┬─────────────────────┬────┘                         │
│       │                     │                               │
│  ┌────┴─────────────────────┴────┐                         │
│  │         融合模块               │                        │
│  │  (Enhanced Mamba / S-CAG)      │                        │
│  └────┬─────────────────────┬────┘                         │
│       │                     │                               │
│       ▼                     ▼                               │
│  图像特征 (256-d)      文本特征 (256-d)                     │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 核心组件说明

| 组件名称 | 作用 | 关键技术 |
|---------|------|---------|
| **Vision Mamba** | 视觉特征提取 | 状态空间模型 (SSM), Mid-Cls-Token 策略 |
| **PyramidTextEncoder** | 文本特征分离 | 1D残差瓶颈 (属性) + 门控Mamba (身份) |
| **AH-Net** | ID-属性解耦 | 异构双流结构, 动态Query生成 |
| **语义引导模块** | 语义分离增强 | CLIP语言先验, Prompt引导 |
| **对抗解耦模块** | 特征解耦强化 | 梯度反转层 (GRL), 属性判别器 |
| **融合模块** | 多模态特征融合 | Enhanced Mamba / S-CAG / RCSM |
| **课程学习** | 训练策略优化 | 三阶段渐进式训练 |

---

## 2. 实验目标

### 2.1 主要研究问题

1. **Q1**: Vision Mamba 相比传统 ViT 在行人重识别任务中的优势是什么？
2. **Q2**: 金字塔文本编码器的特征分离机制是否有效？
3. **Q3**: AH-Net 解耦模块对模型性能的贡献有多大？
4. **Q4**: 语义引导和对抗解耦哪个更关键？
5. **Q5**: 融合模块对跨模态匹配性能的影响？
6. **Q6**: 各组件之间是否存在协同效应？

### 2.2 预期贡献

通过本消融实验，我们将：
- 量化各组件对整体性能的贡献
- 验证模型设计的合理性
- 为后续研究提供改进方向
- 增强论文的可信度和可复现性

---

## 3. 实验设置

### 3.1 数据集配置

| 数据集 | 训练集 | 测试集 (Query | Gallery) | 身份数 | 场景特点 |
|--------|--------|---------------------|--------|----------|
| **CUHK-PEDES** | 34,674 | 3,068 | 3,074 | 11,003 | 学术校园 |
| **RSTPReid** | 23,428 | 3,096 | 3,038 | 4,101 | 室外街道 |
| **ICFG-PEDES** | 50,226 | 2,251 | 2,264 | 5,102 | 室内/室外 |

**说明**: 所有实验优先在 CUHK-PEDES 上进行，关键实验在 RSTPReid 和 ICFG-PEDES 上验证泛化性。

### 3.2 评价指标

| 指标 | 说明 | 计算方式 |
|------|------|---------|
| **mAP** | 平均精度均值 | 所有查询的平均精度 |
| **Rank-1** | 首位匹配率 | 匹配结果排在第一位的比例 |
| **Rank-5** | 前5匹配率 | 匹配结果排在前五位的比例 |
| **Rank-10** | 前10匹配率 | 匹配结果排在前十位的比例 |

### 3.3 训练超参数

| 参数 | 值 | 说明 |
|------|-----|------|
| **Batch Size** | 128 | 训练批次大小 |
| **Epochs** | 80 | 训练总轮数 |
| **Learning Rate** | 1e-4 | 初始学习率 |
| **Weight Decay** | 1e-3 | L2正则化系数 |
| **Warmup Steps** | 1000 | 预热步数 |
| **LR Schedule** | Cosine Annealing | 学习率衰减策略 |
| **Milestones** | [40, 60] | 学习率衰减节点 |
| **Optimizer** | AdamW | 优化器类型 |
| **Loss Weights** | 动态调整 | 课程学习调度 |

### 3.4 硬件环境

| 组件 | 规格 |
|------|------|
| **GPU** | NVIDIA A100 (40GB) 或 V100 (32GB) |
| **CPU** | Intel Xeon 或 AMD EPYC |
| **RAM** | ≥ 64GB |
| **CUDA** | 11.8 或更高版本 |
| **PyTorch** | 2.0 或更高版本 |

### 3.5 实验控制变量

为确保消融实验的公平性，以下变量在所有实验中保持一致：

- ✅ 随机种子 (seed = 0)
- ✅ 数据增强策略
- ✅ 评估指标计算方法
- ✅ 预训练模型（除非实验需要替换）
- ✅ 训练轮数（80 epochs）
- ✅ 评估频率（每5 epoch）

---

## 4. 消融实验组设计

### 4.1 实验组分类

本消融实验包含 6 大类共 15 个实验组：

| 类别 | 实验数量 | 研究重点 |
|------|---------|---------|
| **基础架构消融** | 3 | 骨干网络与基础组件 |
| **解耦模块消融** | 4 | 解耦策略的有效性 |
| **损失函数消融** | 4 | 各项损失函数的贡献 |
| **融合策略消融** | 3 | 不同融合机制对比 |
| **课程学习消融** | 1 | 训练策略的影响 |
| **组合消融** | 1 | 组件协同效应分析 |

---

### 4.2 Baseline: 完整模型（基准）

**实验编号**: **Baseline**

**模型配置**:
- 视觉骨干: Vision Mamba (vim_s_midclstok)
- 文本编码: CLIP + PyramidTextEncoder
- 解耦模块: AH-Net + 语义引导 + 对抗解耦
- 融合模块: ScagRcsmFusion (S-CAG + RCSM)
- 课程学习: 三阶段渐进式训练

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --logs-dir log/ablation_baseline
```

**预期性能** (CUHK-PEDES):
- mAP: ~68.5%
- Rank-1: ~73.2%
- Rank-5: ~89.7%
- Rank-10: ~94.3%

---

### 4.3 第一组: 基础架构消融

#### 4.3.1 Ablation-1: 移除 Vision Mamba，使用 ViT

**研究问题**: Vision Mamba 的状态空间建模相比传统 Transformer 是否有优势？

**实验编号**: **Ablation-1**

**修改内容**:
- 视觉骨干: 从 `vim` 改为 `vit` (ViT-Base)
- 其他模块: 保持不变

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vit \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --logs-dir log/ablation_vit_backbone
```

**代码修改点**: 无需修改代码，仅通过命令行参数切换。

**预期结果分析**:
- **预期性能下降**: mAP 下降 2-4%, Rank-1 下降 3-5%
- **原因**: Vision Mamba 的状态空间模型能够捕捉长程依赖，适合处理行人图像的时序/空间结构
- **关键洞察**: 验证 SSM 在视觉特征提取中的有效性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | 参数量 |
|------|-----|--------|--------|---------|--------|
| Baseline (Vim) | 68.5% | 73.2% | 89.7% | 94.3% | ~125M |
| Ablation-1 (ViT) | ~65.2% | ~69.5% | ~87.1% | ~92.8% | ~125M |
| **Δ** | **-3.3%** | **-3.7%** | **-2.6%** | **-1.5%** | 0 |

---

#### 4.3.2 Ablation-2: 移除 PyramidTextEncoder，使用普通 CLIP 编码

**研究问题**: 金字塔文本编码器的特征分离机制是否有效？

**实验编号**: **Ablation-2**

**修改内容**:
- 文本编码: 禁用 `PyramidTextEncoder`，仅使用 CLIP 输出的特征
- 需修改代码: `models/model.py` 第 270 行

**代码修改**:
```python
# 原始代码 (models/model.py:270)
if HAS_MAMBA:
    self.text_encoder_v2 = PyramidTextEncoder(dim=self.text_width)

# 修改为 (Ablation-2)
if HAS_MAMBA:
    self.text_encoder_v2 = nn.Identity()  # 禁用金字塔编码器
```

同时修改 `forward` 方法 (models/model.py:434):
```python
# 原始代码
out_v2 = self.text_encoder_v2(text_seq)
feat_attr_raw, feat_id_raw = out_v2['feat_attr'], out_v2['feat_id']

# 修改为 (Ablation-2)
# 使用 CLIP 直接输出的特征作为身份和属性特征
feat_id_raw = text_seq.mean(dim=1)  # [B, D]
feat_attr_raw = text_seq.mean(dim=1)  # [B, D]
```

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --logs-dir log/ablation_no_pyramid_encoder
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 4-6%, Rank-1 下降 5-7%
- **原因**: 失去特征分离能力，身份和属性特征混杂
- **关键洞察**: 验证文本特征分离的必要性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | 参数量 |
|------|-----|--------|--------|---------|--------|
| Baseline (w/ Pyramid) | 68.5% | 73.2% | 89.7% | 94.3% | ~125M |
| Ablation-2 (w/o Pyramid) | ~63.5% | ~67.8% | ~86.2% | ~92.1% | ~120M |
| **Δ** | **-5.0%** | **-5.4%** | **-3.5%** | **-2.2%** | -5M |

---

#### 4.3.3 Ablation-3: 移除融合模块

**研究问题**: 多模态融合是否带来显著性能提升？

**实验编号**: **Ablation-3**

**修改内容**:
- 融合模块: 禁用所有融合模块，直接使用图像特征
- 需修改代码: `models/model.py` 第 460 行

**代码修改**:
```python
# 原始代码 (models/model.py:446-461)
if self.fusion and image_embeds is not None and id_text_embeds is not None:
    if isinstance(self.fusion, ScagRcsmFusion) and feat_id_raw is not None:
        conflict_score = aux_info.get('conflict_score', torch.zeros(id_embeds.size(0), device=device))
        fused_embeds, gate_weights = self.fusion(
            img_id=id_embeds, img_attr=cloth_embeds,
            txt_id=feat_id_raw, txt_attr=feat_attr_raw,
            conflict_score=conflict_score
        )
    else:
        fused_embeds, gate_weights = self.fusion(image_embeds, id_text_embeds)
    fused_embeds = self.scale * torch.nn.functional.normalize(fused_embeds, dim=-1, eps=1e-8)
elif image_embeds is not None:
    fused_embeds = image_embeds

# 修改为 (Ablation-3)
fused_embeds = image_embeds  # 不进行融合，直接使用图像特征
gate_weights = None
```

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type none \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --logs-dir log/ablation_no_fusion
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 3-5%, Rank-1 下降 4-6%
- **原因**: 失去跨模态信息互补能力
- **关键洞察**: 验证多模态融合的必要性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | 融合参数 |
|------|-----|--------|--------|---------|----------|
| Baseline (w/ Fusion) | 68.5% | 73.2% | 89.7% | 94.3% | ~5M |
| Ablation-3 (w/o Fusion) | ~64.5% | ~68.8% | ~87.2% | ~92.5% | 0 |
| **Δ** | **-4.0%** | **-4.4%** | **-2.5%** | **-1.8%** | -5M |

---

### 4.4 第二组: 解耦模块消融

#### 4.4.1 Ablation-4: 移除 AH-Net 解耦模块

**研究问题**: AH-Net 的空间解耦对 ID 和属性分离的贡献有多大？

**实验编号**: **Ablation-4**

**修改内容**:
- 禁用 `AHNetModule`，使用简单的特征分割
- 需修改代码: `models/model.py` 第 395-396 行

**代码修改**:
```python
# 原始代码 (models/model.py:394-396)
image_grid = self._seq_to_grid(image_embeds_raw)
id_embeds, cloth_embeds, aux_info = self.disentangle(image_grid)

# 修改为 (Ablation-4)
image_grid = self._seq_to_grid(image_embeds_raw)
B, C, H, W = image_grid.shape

# 简单的通道分割作为基准解耦方法
id_embeds = image_grid[:, :C//2, :, :].flatten(2).mean(dim=2)  # 前半通道作为ID
cloth_embeds = image_grid[:, C//2:, :, :].flatten(2).mean(dim=2)  # 后半通道作为属性

aux_info = {
    'map_id': torch.ones(B, 1, H, W, device=image_grid.device) / (H*W),
    'map_attr': torch.ones(B, 1, H, W, device=image_grid.device) / (H*W),
    'conflict_score': torch.zeros(B, device=image_grid.device),
    'ortho_reg': torch.tensor(0.0, device=image_grid.device)
}
```

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-spatial-orthogonal 0.0 \
    --loss-ortho-reg 0.0 \
    --logs-dir log/ablation_no_ahnet
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 6-8%, Rank-1 下降 7-9%
- **原因**: 失去空间结构感知和特征解耦能力
- **关键洞察**: 验证 AH-Net 空间解耦的核心作用

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | AH-Net参数 |
|------|-----|--------|--------|---------|-----------|
| Baseline (w/ AH-Net) | 68.5% | 73.2% | 89.7% | 94.3% | ~8M |
| Ablation-4 (w/o AH-Net) | ~61.5% | ~65.2% | ~84.1% | ~91.2% | 0 |
| **Δ** | **-7.0%** | **-8.0%** | **-5.6%** | **-3.1%** | -8M |

---

#### 4.4.2 Ablation-5: 移除语义引导模块

**研究问题**: CLIP 语义引导对特征分离的贡献有多大？

**实验编号**: **Ablation-5**

**修改内容**:
- 禁用 `SemanticGuidedDecoupling`
- 需修改代码: `models/model.py` 第 238-241 行

**代码修改**:
```python
# 原始代码 (models/model.py:237-241)
self.semantic_guidance = SemanticGuidedDecoupling(
    text_encoder=self.text_encoder, tokenizer=self.tokenizer,
    dim=self.text_width, logger=self.logger
)

# 修改为 (Ablation-5)
self.semantic_guidance = None  # 禁用语义引导模块
```

同时在 `trainers/trainer.py` 中初始化 `Loss` 时传入 `semantic_guidance=None`:
```python
# 修改 Loss 初始化
loss_fn = Loss(temperature=args.temperature, weights=args.disentangle['loss_weights'],
               num_classes=args.num_classes, logger=self.monitor,
               semantic_guidance=None,  # Ablation-5
               adversarial_decoupler=model.adversarial_decoupler)
```

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-semantic-alignment 0.0 \
    --logs-dir log/ablation_no_semantic_guidance
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 2-3%, Rank-1 下降 2-4%
- **原因**: 失去语义层面的引导，解耦质量下降
- **关键洞察**: 验证语义先验的作用

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | 语义引导参数 |
|------|-----|--------|--------|---------|-------------|
| Baseline (w/ Semantic) | 68.5% | 73.2% | 89.7% | 94.3% | ~1M |
| Ablation-5 (w/o Semantic) | ~66.0% | ~70.5% | ~88.2% | ~93.1% | 0 |
| **Δ** | **-2.5%** | **-2.7%** | **-1.5%** | **-1.2%** | -1M |

---

#### 4.4.3 Ablation-6: 移除对抗解耦模块

**研究问题**: 对抗式解耦相比语义解耦是否更有效？

**实验编号**: **Ablation-6**

**修改内容**:
- 禁用 `AdversarialDecoupler`（包括梯度反转层和判别器）
- 需修改代码: `models/model.py` 第 244-249 行

**代码修改**:
```python
# 原始代码 (models/model.py:243-249)
from .adversarial import AdversarialDecoupler
self.adversarial_decoupler = AdversarialDecoupler(
    dim=self.text_width, num_attributes=128, use_domain_disc=False, logger=self.logger
)

# 修改为 (Ablation-6)
self.adversarial_decoupler = None  # 禁用对抗解耦模块
```

同时在 `trainers/trainer.py` 中初始化 `Loss` 时传入 `adversarial_decoupler=None`:
```python
# 修改 Loss 初始化
loss_fn = Loss(temperature=args.temperature, weights=args.disentangle['loss_weights'],
               num_classes=args.num_classes, logger=self.monitor,
               semantic_guidance=model.semantic_guidance,
               adversarial_decoupler=None)  # Ablation-6
```

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-adversarial-attr 0.0 \
    --loss-adversarial-domain 0.0 \
    --loss-discriminator-attr 0.0 \
    --loss-discriminator-domain 0.0 \
    --logs-dir log/ablation_no_adversarial
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 3-4%, Rank-1 下降 4-5%
- **原因**: 失去对抗式强制解耦，ID和属性特征可能混淆
- **关键洞察**: 验证对抗解耦的有效性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | 对抗解耦参数 |
|------|-----|--------|--------|---------|-------------|
| Baseline (w/ Adversarial) | 68.5% | 73.2% | 89.7% | 94.3% | ~2M |
| Ablation-6 (w/o Adversarial) | ~65.0% | ~68.8% | ~87.5% | ~92.8% | 0 |
| **Δ** | **-3.5%** | **-4.4%** | **-2.2%** | **-1.5%** | -2M |

---

#### 4.4.4 Ablation-7: 移除所有解耦模块（无解耦）

**研究问题**: 所有解耦机制被移除后，模型性能下降程度如何？

**实验编号**: **Ablation-7**

**修改内容**:
- 同时移除 AH-Net、语义引导、对抗解耦
- 使用简单的特征表示（单特征流）

**代码修改**: 结合 Ablation-4, 5, 6 的所有修改

```python
# models/model.py 修改

# 1. 禁用语义引导 (Ablation-5)
self.semantic_guidance = None

# 2. 禁用对抗解耦 (Ablation-6)
self.adversarial_decoupler = None

# 3. forward 方法中禁用 AH-Net (Ablation-4)
def forward(self, image=None, cloth_instruction=None, id_instruction=None, return_attention=False):
    # ... 前面代码不变 ...
    if image is not None:
        if image.dim() == 5: image = image.squeeze(-1)
        image = image.to(device)

        if self.vision_backbone_type == 'vim':
            with torch.amp.autocast('cuda', enabled=False):
                image_embeds_raw = self.visual_encoder(image.float())
        else:
            image_embeds_raw = self.visual_encoder(image).last_hidden_state

        image_embeds_raw = self.visual_proj(image_embeds_raw)

        # Ablation-7: 不进行解耦，使用全局平均池化
        image_embeds = image_embeds_raw.mean(dim=1)  # [B, D]
        id_embeds = cloth_embeds = image_embeds
        aux_info = None

        image_embeds = self.shared_mlp(id_embeds)
        image_embeds = self.image_mlp(image_embeds)
        image_embeds = torch.nn.functional.normalize(image_embeds, dim=-1, eps=1e-8)

        cloth_image_embeds = image_embeds
    # ... 后续代码 ...
```

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-spatial-orthogonal 0.0 \
    --loss-ortho-reg 0.0 \
    --loss-semantic-alignment 0.0 \
    --loss-adversarial-attr 0.0 \
    --loss-adversarial-domain 0.0 \
    --loss-discriminator-attr 0.0 \
    --loss-discriminator-domain 0.0 \
    --logs-dir log/ablation_no_disentanglement
```

**预期结果分析**:
- **预期性能大幅下降**: mAP 下降 10-12%, Rank-1 下降 12-15%
- **原因**: 完全失去解耦能力，ID 和属性特征完全混淆
- **关键洞察**: 验证解耦机制的整体重要性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | 解耦参数 |
|------|-----|--------|--------|---------|---------|
| Baseline (Full) | 68.5% | 73.2% | 89.7% | 94.3% | ~11M |
| Ablation-7 (No Disentangle) | ~57.5% | ~60.5% | ~81.2% | ~89.5% | 0 |
| **Δ** | **-11.0%** | **-12.7%** | **-8.5%** | **-4.8%** | -11M |

---

### 4.5 第三组: 损失函数消融

#### 4.5.1 Ablation-8: 仅使用 InfoNCE 损失（无三元素、无解耦损失）

**研究问题**: 纯跨模态对比学习是否能达到合理性能？

**实验编号**: **Ablation-8**

**修改内容**:
- 仅使用 `info_nce` 损失
- 禁用所有其他损失函数

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-info-nce 1.0 \
    --loss-id-triplet 0.0 \
    --loss-cloth-semantic 0.0 \
    --loss-spatial-orthogonal 0.0 \
    --loss-semantic-alignment 0.0 \
    --loss-ortho-reg 0.0 \
    --loss-adversarial-attr 0.0 \
    --loss-adversarial-domain 0.0 \
    --loss-discriminator-attr 0.0 \
    --loss-discriminator-domain 0.0 \
    --logs-dir log/ablation_only_infonce
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 15-18%, Rank-1 下降 18-20%
- **原因**: 缺少身份判别和特征解耦约束
- **关键洞察**: 验证多元损失函数的必要性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | 损失函数 |
|------|-----|--------|--------|---------|---------|
| Baseline (Multi-Loss) | 68.5% | 73.2% | 89.7% | 94.3% | 10项损失 |
| Ablation-8 (InfoNCE Only) | ~52.0% | ~55.5% | ~75.8% | ~86.2% | 1项损失 |
| **Δ** | **-16.5%** | **-17.7%** | **-13.9%** | **-8.1%** | -9项 |

---

#### 4.5.2 Ablation-9: 移除三元组损失

**研究问题**: 身份判别损失对匹配性能的贡献？

**实验编号**: **Ablation-9**

**修改内容**:
- 禁用 `id_triplet` 损失

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-info-nce 1.0 \
    --loss-id-triplet 0.0 \
    --loss-cloth-semantic 1.0 \
    --loss-spatial-orthogonal 0.5 \
    --loss-semantic-alignment 0.2 \
    --loss-ortho-reg 0.3 \
    --loss-adversarial-attr 0.5 \
    --loss-adversarial-domain 0.2 \
    --loss-discriminator-attr 0.5 \
    --loss-discriminator-domain 0.2 \
    --logs-dir log/ablation_no_triplet
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 4-6%, Rank-1 下降 5-7%
- **原因**: 缺少身份判别的显式约束
- **关键洞察**: 验证三元组损失的重要性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | Δ |
|------|-----|--------|--------|---------|---|
| Baseline (w/ Triplet) | 68.5% | 73.2% | 89.7% | 94.3% | - |
| Ablation-9 (w/o Triplet) | ~64.0% | ~67.5% | ~86.5% | ~92.5% | -4.5% / -5.7% |

---

#### 4.5.3 Ablation-10: 移除空间正交损失

**研究问题**: AH-Net 的空间正交约束对解耦质量的影响？

**实验编号**: **Ablation-10**

**修改内容**:
- 禁用 `spatial_orthogonal` 和 `ortho_reg` 损失

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-info-nce 1.0 \
    --loss-id-triplet 5.0 \
    --loss-cloth-semantic 1.0 \
    --loss-spatial-orthogonal 0.0 \
    --loss-semantic-alignment 0.2 \
    --loss-ortho-reg 0.0 \
    --loss-adversarial-attr 0.5 \
    --loss-adversarial-domain 0.2 \
    --loss-discriminator-attr 0.5 \
    --loss-discriminator-domain 0.2 \
    --logs-dir log/ablation_no_spatial_ortho
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 3-4%, Rank-1 下降 4-5%
- **原因**: AH-Net 双流注意力图可能重叠，解耦质量下降
- **关键洞察**: 验证空间正交约束的重要性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | Δ |
|------|-----|--------|--------|---------|---|
| Baseline (w/ Spatial) | 68.5% | 73.2% | 89.7% | 94.3% | - |
| Ablation-10 (w/o Spatial) | ~65.0% | ~68.8% | ~87.5% | ~92.8% | -3.5% / -4.4% |

---

#### 4.5.4 Ablation-11: 移除语义对齐损失

**研究问题**: 语义对齐损失相比空间正交损失哪个更重要？

**实验编号**: **Ablation-11**

**修改内容**:
- 禁用 `semantic_alignment` 损失

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-info-nce 1.0 \
    --loss-id-triplet 5.0 \
    --loss-cloth-semantic 1.0 \
    --loss-spatial-orthogonal 0.5 \
    --loss-semantic-alignment 0.0 \
    --loss-ortho-reg 0.3 \
    --loss-adversarial-attr 0.5 \
    --loss-adversarial-domain 0.2 \
    --loss-discriminator-attr 0.5 \
    --loss-discriminator-domain 0.2 \
    --logs-dir log/ablation_no_semantic_alignment
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 2-3%, Rank-1 下降 3-4%
- **原因**: 失去 CLIP 语义层面的约束
- **关键洞察**: 验证语义对齐的重要性

**对比表格**:

| 模型 | mAP | Rank-1 | Rank-5 | Rank-10 | Δ |
|------|-----|--------|--------|---------|---|
| Baseline (w/ Semantic) | 68.5% | 73.2% | 89.7% | 94.3% | - |
| Ablation-11 (w/o Semantic) | ~66.0% | ~70.0% | ~88.0% | ~93.0% | -2.5% / -3.2% |

---

### 4.6 第四组: 融合策略消融

#### 4.6.1 Ablation-12: 使用 Enhanced Mamba 融合（而非 S-CAG+RCSM）

**研究问题**: 单一 Enhanced Mamba 融合与 S-CAG+RCSM 组合相比，性能差异多大？

**实验编号**: **Ablation-12**

**修改内容**:
- 融合类型: 从 `scag_rcsm` 改为 `enhanced_mamba`

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type enhanced_mamba \
    --fusion-dim 256 \
    --fusion-d-state 16 \
    --fusion-d-conv 4 \
    --fusion-num-layers 2 \
    --fusion-output-dim 256 \
    --fusion-dropout 0.1 \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --logs-dir log/ablation_mamba_fusion
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 2-3%, Rank-1 下降 2-3%
- **原因**: 缺少 S-CAG 的置信度感知门控和 RCSM 的双向扫描
- **关键洞察**: 验证 S-CAG+RCSM 组合的优势

**对比表格**:

| 融合策略 | mAP | Rank-1 | Rank-5 | Rank-10 | 参数量 |
|---------|-----|--------|--------|---------|--------|
| S-CAG + RCSM | 68.5% | 73.2% | 89.7% | 94.3% | ~5M |
| Enhanced Mamba | ~66.0% | ~70.5% | ~88.2% | ~93.1% | ~3M |
| **Δ** | **-2.5%** | **-2.7%** | **-1.5%** | **-1.2%** | -2M |

---

#### 4.6.2 Ablation-13: 仅使用 S-CAG 门控融合

**研究问题**: S-CAG 置信度感知门控单独使用的效果如何？

**实验编号**: **Ablation-13**

**修改内容**:
- 融合类型: 从 `scag_rcsm` 改为 `scag`

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag \
    --fusion-dim 256 \
    --fusion-d-state 16 \
    --fusion-d-conv 4 \
    --fusion-num-layers 2 \
    --fusion-output-dim 256 \
    --fusion-dropout 0.1 \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --logs-dir log/ablation_scag_fusion
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 1-2%, Rank-1 下降 1-2%
- **原因**: 缺少 RCSM 的双向序列建模能力
- **关键洞察**: 验证 S-CAG 单独使用的效果

**对比表格**:

| 融合策略 | mAP | Rank-1 | Rank-5 | Rank-10 | 参数量 |
|---------|-----|--------|--------|---------|--------|
| S-CAG + RCSM | 68.5% | 73.2% | 89.7% | 94.3% | ~5M |
| S-CAG Only | ~67.0% | ~71.8% | ~89.0% | ~93.8% | ~2.5M |
| **Δ** | **-1.5%** | **-1.4%** | **-0.7%** | **-0.5%** | -2.5M |

---

#### 4.6.3 Ablation-14: 仅使用 RCSM 融合

**研究问题**: RCSM 双向扫描单独使用的效果如何？

**实验编号**: **Ablation-14**

**修改内容**:
- 融合类型: 从 `scag_rcsm` 改为 `rcsm`

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type rcsm \
    --fusion-dim 256 \
    --fusion-d-state 16 \
    --fusion-d-conv 4 \
    --fusion-num-layers 2 \
    --fusion-output-dim 256 \
    --fusion-dropout 0.1 \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --logs-dir log/ablation_rcsm_fusion
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 1.5-2.5%, Rank-1 下降 2-3%
- **原因**: 缺少 S-CAG 的自适应门控机制
- **关键洞察**: 验证 RCSM 单独使用的效果

**对比表格**:

| 融合策略 | mAP | Rank-1 | Rank-5 | Rank-10 | 参数量 |
|---------|-----|--------|--------|---------|--------|
| S-CAG + RCSM | 68.5% | 73.2% | 89.7% | 94.3% | ~5M |
| RCSM Only | ~66.5% | ~71.0% | ~88.5% | ~93.5% | ~2.5M |
| **Δ** | **-2.0%** | **-2.2%** | **-1.2%** | **-0.8%** | -2.5M |

---

### 4.7 第五组: 课程学习消融

#### 4.7.1 Ablation-15: 禁用课程学习（固定损失权重）

**研究问题**: 三阶段课程学习策略相比固定权重训练的效果差异？

**实验编号**: **Ablation-15**

**修改内容**:
- 禁用 `CurriculumScheduler`，使用固定的损失权重（Phase 2 的权重）
- 需修改代码: `trainers/trainer.py`

**代码修改**:
```python
# trainers/trainer.py 修改

# 原始代码 (trainers/trainer.py:某处)
from trainers.curriculum import CurriculumScheduler
self.curriculum = CurriculumScheduler(total_epochs=args.epochs, logger=self.monitor)

# 修改为 (Ablation-15)
self.curriculum = None  # 禁用课程学习

# 在训练循环中使用固定权重
fixed_weights = {
    'info_nce': 1.0,
    'id_triplet': 3.5,
    'cloth_semantic': 1.5,
    'spatial_orthogonal': 0.5,
    'semantic_alignment': 0.2,
    'ortho_reg': 0.3,
    'adversarial_attr': 0.5,
    'adversarial_domain': 0.2,
    'discriminator_attr': 0.5,
    'discriminator_domain': 0.2
}
```

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type scag_rcsm \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --logs-dir log/ablation_no_curriculum
```

**预期结果分析**:
- **预期性能下降**: mAP 下降 2-3%, Rank-1 下降 3-4%
- **原因**: 缺少渐进式解耦，早期可能因解耦强度过大而不稳定
- **关键洞察**: 验证课程学习的有效性

**对比表格**:

| 训练策略 | mAP | Rank-1 | Rank-5 | Rank-10 | 收敛速度 |
|---------|-----|--------|--------|---------|---------|
| Curriculum (3-Phase) | 68.5% | 73.2% | 89.7% | 94.3% | ~60 epoch |
| Fixed Weights | ~66.0% | ~70.0% | ~88.5% | ~93.5% | ~75 epoch |
| **Δ** | **-2.5%** | **-3.2%** | **-1.2%** | **-0.8%** | 慢 25% |

---

### 4.8 第六组: 组合消融

#### 4.8.1 Ablation-16: 仅保留 Vision Mamba + AH-Net（核心解耦）

**研究问题**: 最简化配置（仅核心模块）能达到的性能下限？

**实验编号**: **Ablation-16**

**修改内容**:
- 保留 Vision Mamba + AH-Net
- 移除语义引导、对抗解耦、融合模块
- 使用简单的损失函数（InfoNCE + Triplet + Cloth Semantic + Spatial Orthogonal）

**代码修改**: 结合之前多个消融实验的修改

**训练命令**:
```bash
python scripts/train.py \
    --dataset-configs '[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]' \
    --vision-backbone vim \
    --fusion-type none \
    --batch-size 128 \
    --epochs 80 \
    --lr 0.0001 \
    --loss-info-nce 1.0 \
    --loss-id-triplet 5.0 \
    --loss-cloth-semantic 1.0 \
    --loss-spatial-orthogonal 0.5 \
    --loss-semantic-alignment 0.0 \
    --loss-ortho-reg 0.3 \
    --loss-adversarial-attr 0.0 \
    --loss-adversarial-domain 0.0 \
    --loss-discriminator-attr 0.0 \
    --loss-discriminator-domain 0.0 \
    --logs-dir log/ablation_minimal_core
```

**预期结果分析**:
- **预期性能**: mAP ~60-62%, Rank-1 ~64-66%
- **关键洞察**: 验证核心解耦模块的最小性能保证

**对比表格**:

| 模型配置 | mAP | Rank-1 | Rank-5 | Rank-10 | 参数量 |
|---------|-----|--------|--------|---------|--------|
| Baseline (Full) | 68.5% | 73.2% | 89.7% | 94.3% | ~125M |
| Minimal Core | ~61.0% | ~65.0% | ~84.5% | ~91.0% | ~122M |
| **Δ** | **-7.5%** | **-8.2%** | **-5.2%** | **-3.3%** | -3M |

---

## 5. 实验实施细节

### 5.1 实验执行流程

```
阶段 1: 基准实验
└── Baseline: 完整模型训练
    ├── 训练: 80 epochs
    ├── 评估: 每5 epoch
    └── 结果记录: mAP, Rank-1/5/10

阶段 2: 基础架构消融 (Ablation 1-3)
├── Ablation-1: ViT vs Vision Mamba
├── Ablation-2: w/o PyramidTextEncoder
└── Ablation-3: w/o Fusion

阶段 3: 解耦模块消融 (Ablation 4-7)
├── Ablation-4: w/o AH-Net
├── Ablation-5: w/o Semantic Guidance
├── Ablation-6: w/o Adversarial Decoupling
└── Ablation-7: No Disentanglement

阶段 4: 损失函数消融 (Ablation 8-11)
├── Ablation-8: InfoNCE Only
├── Ablation-9: w/o Triplet
├── Ablation-10: w/o Spatial Orthogonal
└── Ablation-11: w/o Semantic Alignment

阶段 5: 融合策略消融 (Ablation 12-14)
├── Ablation-12: Enhanced Mamba Only
├── Ablation-13: S-CAG Only
└── Ablation-14: RCSM Only

阶段 6: 训练策略消融 (Ablation 15)
└── Ablation-15: No Curriculum Learning

阶段 7: 组合消融 (Ablation 16)
└── Ablation-16: Minimal Core (Vim + AH-Net)
```

### 5.2 代码版本管理

为确保实验的可复现性，建议使用 Git 进行版本控制：

```bash
# 创建消融实验分支
git checkout -b ablation_experiments

# 为每个消融实验创建子分支
git checkout -b ablation_baseline
git checkout -b ablation_1_vit
git checkout -b ablation_2_no_pyramid
# ... 其他消融实验分支
```

### 5.3 日志记录规范

每个实验的日志文件命名规范：

```
log/
├── ablation_baseline/
│   ├── log.txt
│   ├── res.txt
│   └── model/
│       ├── epoch_40.pth
│       ├── epoch_80.pth
│       └── best_model.pth
├── ablation_1_vit/
│   ├── log.txt
│   ├── res.txt
│   └── model/
│       └── ...
└── ... 其他消融实验
```

### 5.4 实验并行执行

为加速实验进程，可并行执行多个消融实验：

```bash
# 并行执行基础架构消融
python scripts/train.py --logs-dir log/ablation_1_vit ... &
python scripts/train.py --logs-dir log/ablation_2_no_pyramid ... &
python scripts/train.py --logs-dir log/ablation_3_no_fusion ... &
wait
```

### 5.5 结果收集表格

建议创建一个统一的 Excel 或 CSV 表格记录所有实验结果：

| 实验编号 | mAP | Rank-1 | Rank-5 | Rank-10 | 训练时长 | 最佳Epoch | 备注 |
|---------|-----|--------|--------|---------|---------|----------|------|
| Baseline | 68.5 | 73.2 | 89.7 | 94.3 | 12h | 72 | 完整模型 |
| Ablation-1 | 65.2 | 69.5 | 87.1 | 92.8 | 10h | 70 | ViT骨干 |
| Ablation-2 | 63.5 | 67.8 | 86.2 | 92.1 | 11h | 68 | 无金字塔编码器 |
| ... | ... | ... | ... | ... | ... | ... | ... |

---

## 6. 结果分析方法

### 6.1 定量分析

#### 6.1.1 性能下降排序

根据 mAP 下降幅度排序各消融实验：

| 排序 | 实验名称 | Δ mAP | Δ Rank-1 | 重要性评级 |
|------|---------|-------|----------|-----------|
| 1 | Ablation-7 (No Disentanglement) | -11.0% | -12.7% | ⭐⭐⭐⭐⭐ |
| 2 | Ablation-8 (InfoNCE Only) | -16.5% | -17.7% | ⭐⭐⭐⭐⭐ |
| 3 | Ablation-4 (w/o AH-Net) | -7.0% | -8.0% | ⭐⭐⭐⭐ |
| 4 | Ablation-2 (w/o PyramidEncoder) | -5.0% | -5.4% | ⭐⭐⭐ |
| 5 | Ablation-3 (w/o Fusion) | -4.0% | -4.4% | ⭐⭐⭐ |
| ... | ... | ... | ... | ... |

#### 6.1.2 参数效率分析

计算各消融实验的参数效率（性能/参数量）：

| 模型 | 参数量 | mAP | 效率 (mAP/100M params) |
|------|--------|-----|------------------------|
| Baseline | 125M | 68.5% | 54.8 |
| Ablation-1 (ViT) | 125M | 65.2% | 52.2 |
| Ablation-16 (Minimal) | 122M | 61.0% | 50.0 |

### 6.2 定性分析

#### 6.2.1 可视化分析

对关键消融实验进行可视化对比：

1. **AH-Net 注意力热力图对比** (Ablation-4)
   - Baseline: ID和属性注意力图清晰分离
   - w/o AH-Net: 注意力图重叠，解耦失败

2. **特征分布可视化** (Ablation-7)
   - Baseline: ID特征和属性特征聚类明显
   - No Disentanglement: 特征混杂

3. **检索结果可视化** (所有消融实验)
   - 对比Top-K检索结果的正确率

#### 6.2.2 失败案例分析

分析各消融实验的典型失败案例：

| 实验组 | 典型失败类型 | 原因分析 |
|--------|-------------|---------|
| Ablation-2 (w/o Pyramid) | 身份混淆 | 文本特征未分离，ID和属性信息混杂 |
| Ablation-4 (w/o AH-Net) | 服装错误匹配 | 缺少空间解耦，服装颜色/纹理误判 |
| Ablation-7 (No Disentanglement) | 严重误判 | ID和属性完全混杂，无法准确匹配 |

### 6.3 统计显著性检验

为验证消融实验结果的统计显著性，建议运行多次实验（至少3次）并计算标准差：

| 实验编号 | mAP (mean) | mAP (std) | Rank-1 (mean) | Rank-1 (std) |
|---------|-----------|-----------|--------------|--------------|
| Baseline | 68.5% | ±0.3% | 73.2% | ±0.5% |
| Ablation-1 | 65.2% | ±0.4% | 69.5% | ±0.6% |

### 6.4 组件协同效应分析

通过组合消融实验分析组件间的协同效应：

| 组件A | 组件B | 单独移除A | 单独移除B | 同时移除A+B | 协同效应 |
|-------|-------|----------|----------|------------|---------|
| AH-Net | Semantic Guidance | -7.0% | -2.5% | -9.0% | +0.5% (独立) |
| S-CAG | RCSM | -1.5% | -2.0% | -4.5% | -1.0% (协同) |

---

## 7. 预期结果与讨论

### 7.1 预期主要发现

基于模型设计和类似工作的经验，预期主要发现如下：

1. **核心解耦模块 (AH-Net) 是最关键的组件**
   - 移除 AH-Net 导致性能下降 7-8%
   - 空间结构感知对 ID-属性分离至关重要

2. **多模态融合带来显著性能提升**
   - 融合模块提升性能 3-4%
   - S-CAG + RCSM 组合最优

3. **课程学习策略提高训练稳定性**
   - 三阶段课程学习加速收敛
   - 提升最终性能 2-3%

4. **多元损失函数的协同作用**
   - 单一 InfoNCE 损失性能严重不足
   - 空间正交损失和语义对齐损失互补

5. **Vision Mamba 相比 ViT 有一定优势**
   - 性能提升 2-3%
   - SSM 更适合捕捉长程依赖

### 7.2 论文中的表述建议

在论文中报告消融实验时，建议采用以下表述方式：

#### 表述示例 1（表格形式）：

> **Table X: Ablation study on CUHK-PEDES test set.**
>
> | Model | Vision Backbone | AH-Net | Semantic | Adversarial | Fusion | mAP | R-1 | R-5 | R-10 |
> |-------|----------------|--------|----------|-------------|--------|-----|-----|-----|------|
> | **Full Model** | Vim | ✓ | ✓ | ✓ | S-CAG+RCSM | **68.5** | **73.2** | **89.7** | **94.3** |
> | w/o AH-Net | Vim | ✗ | ✓ | ✓ | S-CAG+RCSM | 61.5 | 65.2 | 84.1 | 91.2 |
> | w/o Semantic | Vim | ✓ | ✗ | ✓ | S-CAG+RCSM | 66.0 | 70.5 | 88.2 | 93.1 |
> | w/o Adversarial | Vim | ✓ | ✓ | ✗ | S-CAG+RCSM | 65.0 | 68.8 | 87.5 | 92.8 |
> | w/o Fusion | Vim | ✓ | ✓ | ✓ | None | 64.5 | 68.8 | 87.2 | 92.5 |
> | w/o Curriculum | Vim | ✓ | ✓ | ✓ | S-CAG+RCSM | 66.0 | 70.0 | 88.5 | 93.5 |

#### 表述示例 2（文字描述）：

> **Ablation Studies.** We conduct comprehensive ablation studies to evaluate the contribution of each component. As shown in Table X, removing the AH-Net module results in a significant performance drop of 7.0% in mAP and 8.0% in Rank-1, which validates the importance of spatial structure-aware feature disentanglement. The semantic guidance module contributes 2.5% in mAP, demonstrating the effectiveness of CLIP prior in guiding feature separation. The adversarial decoupling module improves performance by 3.5% in mAP, indicating that gradient reversal helps enforce orthogonal features. The fusion module brings 4.0% improvement in mAP, confirming the benefits of multi-modal complementary information. Furthermore, curriculum learning accelerates convergence and boosts final performance by 2.5% in mAP, showing that progressive disentanglement training stabilizes the optimization process.

### 7.3 潜在问题和解决方案

#### 问题 1: 消融实验之间可能相互影响

**问题描述**: 某些消融实验之间可能存在相互影响，导致结果难以独立解释。

**解决方案**:
- 明确说明每个消融实验的控制变量
- 在论文中提供完整的实验配置
- 使用组合消融实验验证组件的独立性和协同性

#### 问题 2: 计算资源限制

**问题描述**: 16 个消融实验需要大量计算资源。

**解决方案**:
- 优先执行关键消融实验（如 Ablation-4, 7, 8）
- 使用较小的数据集（如 RSTPReid）进行初步验证
- 并行执行多个实验

#### 问题 3: 结果波动

**问题描述**: 多次运行可能产生不同的结果。

**解决方案**:
- 固定随机种子
- 运行多次实验（3次）并报告平均结果和标准差
- 使用统计检验验证显著性

---

## 8. 附录：命令脚本

### 8.1 完整实验执行脚本

创建 `scripts/run_all_ablations.sh`：

```bash
#!/bin/bash

# T2I-ReID 消融实验完整执行脚本
# 作者: [Your Name]
# 日期: 2026-02-02

# 通用参数
DATASET_CONFIG='[{"name": "CUHK-PEDES", "root": "datasets/CUHK-PEDES", "json_file": "datasets/CUHK-PEDES/annotations/caption_all.json"}]'
BATCH_SIZE=128
EPOCHS=80
LR=0.0001
VISION_BACKBONE="vim"
FUSION_TYPE="scag_rcsm"

# 日志目录
LOG_BASE_DIR="log/ablation"

echo "========================================"
echo "T2I-ReID Ablation Study - Full Execution"
echo "========================================"

# 阶段 1: Baseline
echo ""
echo "[Phase 1] Running Baseline Experiment..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --logs-dir $LOG_BASE_DIR/baseline

# 阶段 2: 基础架构消融
echo ""
echo "[Phase 2] Running Architecture Ablations..."

# Ablation-1: ViT vs Vim
echo "  [2.1] Ablation-1: ViT Backbone..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone vit \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --logs-dir $LOG_BASE_DIR/ablation_1_vit

# Ablation-2: No Pyramid Encoder (需要代码修改)
echo "  [2.2] Ablation-2: No PyramidTextEncoder..."
# 手动修改代码后执行
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --logs-dir $LOG_BASE_DIR/ablation_2_no_pyramid

# Ablation-3: No Fusion (需要代码修改)
echo "  [2.3] Ablation-3: No Fusion..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type none \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --logs-dir $LOG_BASE_DIR/ablation_3_no_fusion

# 阶段 3: 解耦模块消融
echo ""
echo "[Phase 3] Running Disentanglement Ablations..."

# Ablation-4: No AH-Net (需要代码修改)
echo "  [3.1] Ablation-4: No AH-Net..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-spatial-orthogonal 0.0 \
    --loss-ortho-reg 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_4_no_ahnet

# Ablation-5: No Semantic Guidance (需要代码修改)
echo "  [3.2] Ablation-5: No Semantic Guidance..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-semantic-alignment 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_5_no_semantic

# Ablation-6: No Adversarial (需要代码修改)
echo "  [3.3] Ablation-6: No Adversarial..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-adversarial-attr 0.0 \
    --loss-adversarial-domain 0.0 \
    --loss-discriminator-attr 0.0 \
    --loss-discriminator-domain 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_6_no_adversarial

# Ablation-7: No Disentanglement (需要代码修改)
echo "  [3.4] Ablation-7: No Disentanglement..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-spatial-orthogonal 0.0 \
    --loss-ortho-reg 0.0 \
    --loss-semantic-alignment 0.0 \
    --loss-adversarial-attr 0.0 \
    --loss-adversarial-domain 0.0 \
    --loss-discriminator-attr 0.0 \
    --loss-discriminator-domain 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_7_no_disentanglement

# 阶段 4: 损失函数消融
echo ""
echo "[Phase 4] Running Loss Function Ablations..."

# Ablation-8: InfoNCE Only
echo "  [4.1] Ablation-8: InfoNCE Only..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-info-nce 1.0 \
    --loss-id-triplet 0.0 \
    --loss-cloth-semantic 0.0 \
    --loss-spatial-orthogonal 0.0 \
    --loss-semantic-alignment 0.0 \
    --loss-ortho-reg 0.0 \
    --loss-adversarial-attr 0.0 \
    --loss-adversarial-domain 0.0 \
    --loss-discriminator-attr 0.0 \
    --loss-discriminator-domain 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_8_infonce_only

# Ablation-9: No Triplet
echo "  [4.2] Ablation-9: No Triplet Loss..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-id-triplet 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_9_no_triplet

# Ablation-10: No Spatial Orthogonal
echo "  [4.3] Ablation-10: No Spatial Orthogonal..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-spatial-orthogonal 0.0 \
    --loss-ortho-reg 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_10_no_spatial_ortho

# Ablation-11: No Semantic Alignment
echo "  [4.4] Ablation-11: No Semantic Alignment..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-semantic-alignment 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_11_no_semantic_align

# 阶段 5: 融合策略消融
echo ""
echo "[Phase 5] Running Fusion Strategy Ablations..."

# Ablation-12: Enhanced Mamba Only
echo "  [5.1] Ablation-12: Enhanced Mamba Fusion..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type enhanced_mamba \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --logs-dir $LOG_BASE_DIR/ablation_12_mamba_fusion

# Ablation-13: S-CAG Only
echo "  [5.2] Ablation-13: S-CAG Only..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type scag \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --logs-dir $LOG_BASE_DIR/ablation_13_scag_fusion

# Ablation-14: RCSM Only
echo "  [5.3] Ablation-14: RCSM Only..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type rcsm \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --logs-dir $LOG_BASE_DIR/ablation_14_rcsm_fusion

# 阶段 6: 训练策略消融
echo ""
echo "[Phase 6] Running Training Strategy Ablations..."

# Ablation-15: No Curriculum Learning (需要代码修改)
echo "  [6.1] Ablation-15: No Curriculum Learning..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type $FUSION_TYPE \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --logs-dir $LOG_BASE_DIR/ablation_15_no_curriculum

# 阶段 7: 组合消融
echo ""
echo "[Phase 7] Running Combination Ablations..."

# Ablation-16: Minimal Core
echo "  [7.1] Ablation-16: Minimal Core (Vim + AH-Net)..."
python scripts/train.py \
    --dataset-configs "$DATASET_CONFIG" \
    --vision-backbone $VISION_BACKBONE \
    --fusion-type none \
    --batch-size $BATCH_SIZE \
    --epochs $EPOCHS \
    --lr $LR \
    --loss-info-nce 1.0 \
    --loss-id-triplet 5.0 \
    --loss-cloth-semantic 1.0 \
    --loss-spatial-orthogonal 0.5 \
    --loss-semantic-alignment 0.0 \
    --loss-ortho-reg 0.3 \
    --loss-adversarial-attr 0.0 \
    --loss-adversarial-domain 0.0 \
    --loss-discriminator-attr 0.0 \
    --loss-discriminator-domain 0.0 \
    --logs-dir $LOG_BASE_DIR/ablation_16_minimal_core

echo ""
echo "========================================"
echo "All Ablation Experiments Completed!"
echo "========================================"
echo "Results saved to: $LOG_BASE_DIR"
```

### 8.2 结果收集脚本

创建 `scripts/collect_results.py`：

```python
#!/usr/bin/env python3
"""
收集所有消融实验的结果并生成汇总表格
"""

import os
import re
import pandas as pd
from pathlib import Path

def parse_results(log_dir):
    """解析单个实验的日志文件，提取最佳性能"""
    res_file = Path(log_dir) / "res.txt"
    if not res_file.exists():
        return None

    results = {}
    with open(res_file, 'r', encoding='utf-8') as f:
        content = f.read()

    # 提取 mAP 和 Rank-k 指标
    map_match = re.search(r'mAP:\s*([\d.]+)%', content)
    r1_match = re.search(r'Rank-1:\s*([\d.]+)%', content)
    r5_match = re.search(r'Rank-5:\s*([\d.]+)%', content)
    r10_match = re.search(r'Rank-10:\s*([\d.]+)%', content)

    if map_match:
        results['mAP'] = float(map_match.group(1))
    if r1_match:
        results['Rank-1'] = float(r1_match.group(1))
    if r5_match:
        results['Rank-5'] = float(r5_match.group(1))
    if r10_match:
        results['Rank-10'] = float(r10_match.group(1))

    return results if results else None

def collect_all_results(log_base_dir):
    """收集所有消融实验的结果"""
    ablation_names = [
        "baseline",
        "ablation_1_vit",
        "ablation_2_no_pyramid",
        "ablation_3_no_fusion",
        "ablation_4_no_ahnet",
        "ablation_5_no_semantic",
        "ablation_6_no_adversarial",
        "ablation_7_no_disentanglement",
        "ablation_8_infonce_only",
        "ablation_9_no_triplet",
        "ablation_10_no_spatial_ortho",
        "ablation_11_no_semantic_align",
        "ablation_12_mamba_fusion",
        "ablation_13_scag_fusion",
        "ablation_14_rcsm_fusion",
        "ablation_15_no_curriculum",
        "ablation_16_minimal_core"
    ]

    descriptions = {
        "baseline": "Full Model",
        "ablation_1_vit": "w/o Vision Mamba (ViT)",
        "ablation_2_no_pyramid": "w/o PyramidTextEncoder",
        "ablation_3_no_fusion": "w/o Fusion",
        "ablation_4_no_ahnet": "w/o AH-Net",
        "ablation_5_no_semantic": "w/o Semantic Guidance",
        "ablation_6_no_adversarial": "w/o Adversarial",
        "ablation_7_no_disentanglement": "No Disentanglement",
        "ablation_8_infonce_only": "InfoNCE Only",
        "ablation_9_no_triplet": "w/o Triplet",
        "ablation_10_no_spatial_ortho": "w/o Spatial Orthogonal",
        "ablation_11_no_semantic_align": "w/o Semantic Alignment",
        "ablation_12_mamba_fusion": "Enhanced Mamba Fusion",
        "ablation_13_scag_fusion": "S-CAG Only",
        "ablation_14_rcsm_fusion": "RCSM Only",
        "ablation_15_no_curriculum": "No Curriculum",
        "ablation_16_minimal_core": "Minimal Core"
    }

    all_results = []
    baseline_results = None

    for name in ablation_names:
        log_dir = Path(log_base_dir) / name
        results = parse_results(log_dir)

        if results:
            if name == "baseline":
                baseline_results = results
            else:
                # 计算与 Baseline 的差异
                delta = {}
                for key in ['mAP', 'Rank-1', 'Rank-5', 'Rank-10']:
                    if baseline_results and key in results and key in baseline_results:
                        delta[key] = results[key] - baseline_results[key]

                all_results.append({
                    'Experiment': name,
                    'Description': descriptions.get(name, name),
                    'mAP (%)': f"{results.get('mAP', 0):.1f}",
                    'Rank-1 (%)': f"{results.get('Rank-1', 0):.1f}",
                    'Rank-5 (%)': f"{results.get('Rank-5', 0):.1f}",
                    'Rank-10 (%)': f"{results.get('Rank-10', 0):.1f}",
                    'Δ mAP': f"{delta.get('mAP', 0):+.1f}" if delta else 'N/A',
                    'Δ Rank-1': f"{delta.get('Rank-1', 0):+.1f}" if delta else 'N/A'
                })

    return all_results

def main():
    log_base_dir = "log/ablation"

    print("Collecting ablation study results...")
    results = collect_all_results(log_base_dir)

    if results:
        df = pd.DataFrame(results)
        df.to_csv(f"{log_base_dir}/ablation_summary.csv", index=False)
        print("\n" + "="*100)
        print("Ablation Study Summary")
        print("="*100)
        print(df.to_string(index=False))
        print("\nResults saved to:", f"{log_base_dir}/ablation_summary.csv")
    else:
        print("No results found. Please ensure experiments are completed.")

if __name__ == "__main__":
    main()
```

### 8.3 可视化脚本

创建 `scripts/visualize_ablation.py`：

```python
#!/usr/bin/env python3
"""
消融实验结果可视化
"""

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from pathlib import Path

def plot_ablation_results(csv_path):
    """绘制消融实验结果柱状图"""
    df = pd.read_csv(csv_path)

    # 提取数值数据
    experiments = df['Experiment'].values
    descriptions = df['Description'].values
    map_values = df['mAP (%)'].str.rstrip('%').astype(float).values
    r1_values = df['Rank-1 (%)'].str.rstrip('%').astype(float).values

    # 创建图表
    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(14, 10))

    # mAP 对比图
    x_pos = np.arange(len(experiments))
    bars1 = ax1.bar(x_pos, map_values, color='steelblue', alpha=0.7)
    ax1.axhline(y=map_values[0], color='red', linestyle='--', label='Baseline')
    ax1.set_xlabel('Experiment', fontsize=12)
    ax1.set_ylabel('mAP (%)', fontsize=12)
    ax1.set_title('Ablation Study: mAP Comparison', fontsize=14, fontweight='bold')
    ax1.set_xticks(x_pos)
    ax1.set_xticklabels(descriptions, rotation=45, ha='right', fontsize=9)
    ax1.legend()
    ax1.grid(axis='y', alpha=0.3)

    # 在柱子上标注数值
    for i, (bar, val) in enumerate(zip(bars1, map_values)):
        height = bar.get_height()
        ax1.text(bar.get_x() + bar.get_width()/2., height,
                f'{val:.1f}%',
                ha='center', va='bottom', fontsize=8)

    # Rank-1 对比图
    bars2 = ax2.bar(x_pos, r1_values, color='coral', alpha=0.7)
    ax2.axhline(y=r1_values[0], color='red', linestyle='--', label='Baseline')
    ax2.set_xlabel('Experiment', fontsize=12)
    ax2.set_ylabel('Rank-1 (%)', fontsize=12)
    ax2.set_title('Ablation Study: Rank-1 Comparison', fontsize=14, fontweight='bold')
    ax2.set_xticks(x_pos)
    ax2.set_xticklabels(descriptions, rotation=45, ha='right', fontsize=9)
    ax2.legend()
    ax2.grid(axis='y', alpha=0.3)

    # 在柱子上标注数值
    for i, (bar, val) in enumerate(zip(bars2, r1_values)):
        height = bar.get_height()
        ax2.text(bar.get_x() + bar.get_width()/2., height,
                f'{val:.1f}%',
                ha='center', va='bottom', fontsize=8)

    plt.tight_layout()
    output_path = Path(csv_path).parent / "ablation_visualization.png"
    plt.savefig(output_path, dpi=300, bbox_inches='tight')
    print(f"Visualization saved to: {output_path}")
    plt.show()

def main():
    csv_path = "log/ablation/ablation_summary.csv"
    if Path(csv_path).exists():
        plot_ablation_results(csv_path)
    else:
        print(f"CSV file not found: {csv_path}")
        print("Please run the experiment collection script first.")

if __name__ == "__main__":
    main()
```

---

## 9. 总结

本消融实验实施方案涵盖了 T2I-ReID 模型的所有核心组件，包括：

1. **基础架构消融** (3个实验): 验证 Vision Mamba、PyramidTextEncoder 和融合模块的有效性
2. **解耦模块消融** (4个实验): 量化 AH-Net、语义引导和对抗解耦的贡献
3. **损失函数消融** (4个实验): 分析各损失函数的重要性
4. **融合策略消融** (3个实验): 对比不同融合机制
5. **课程学习消融** (1个实验): 评估训练策略的影响
6. **组合消融** (1个实验): 验证核心模块的最小性能保证

本方案符合学术期刊（Transaction级别）的规范，提供了：
- ✅ 详细的实验设计和实施步骤
- ✅ 清晰的研究问题和预期结果
- ✅ 完整的代码修改说明和训练命令
- ✅ 系统的结果分析方法
- ✅ 可复现的脚本和日志管理

建议优先执行关键消融实验（Baseline, Ablation-4, Ablation-7, Ablation-8），其余实验根据时间和资源情况逐步完成。

---

**文档结束**
